<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>PCAWG14-3 extended noncoding RNA Profiling by dyndna</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">PCAWG14-3 extended noncoding RNA Profiling</h1>
      <h2 class="project-tagline">Docker image for TCGA/ICGC PCAWG14-3 Extended Noncoding RNA Expression Profiling</h2>
      <a href="https://github.com/dyndna/pcawg14_htseq" class="btn">View on GitHub</a>
      <a href="https://github.com/dyndna/pcawg14_htseq/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/dyndna/pcawg14_htseq/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h3>
<a id="pcawg-14---3-htseq-rnaseq-analysis-pipeline" class="anchor" href="#pcawg-14---3-htseq-rnaseq-analysis-pipeline" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>PCAWG-14 &amp; -3 HTSeq RNAseq analysis pipeline</h3>

<p><a href="https://github.com/dyndna/pcawg14_htseq/releases/tag/0.9.4p4"><img src="https://img.shields.io/badge/version-0.9.4p4-brightgreen.svg" alt="Version 0.9.4p4"></a> <a href="https://github.com/dyndna/pcawg14_htseq/releases/tag/0.9.4p4"><img src="https://img.shields.io/badge/status-stable-brightgreen.svg" alt="Status Stable"></a> <a href="https://registry.hub.docker.com/u/dyndna/docker-for-pcawg14-htseq/dockerfile/"><img src="https://img.shields.io/badge/Dockerfile-v0.9.2-brightgreen.svg" alt="Dockerfile" title="Build Instructions"></a> <a href="https://registry.hub.docker.com/u/dyndna/pcawg14_htseq"><img src="https://img.shields.io/badge/docker-dyndna/pcawg14_htseq:0.9.2-brightgreen.svg" alt="Docker v0.9.2" title="docker pull dyndna/pcawg14_htseq:0.9.2"></a></p>

<h4>
<a id="docker-image-maintainer" class="anchor" href="#docker-image-maintainer" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Docker image maintainer:</h4>

<ul>
<li>
<a href="https://sbamin.com/contact">Samir B. Amin</a><br>
</li>
</ul>

<blockquote>
<p><a href="https://hub.docker.com/r/dyndna/pcawg14_htseq">Docker image: dyndna/pcawg14_htseq</a>  </p>
</blockquote>

<h4>
<a id="acknowledgement" class="anchor" href="#acknowledgement" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Acknowledgement:</h4>

<ul>
<li>  Morten Muhlig Nielsen, PhD &amp; Prof. Jakob Skou Pederson, PhD</li>
<li>  <a href="https://github.com/jourdren">Laurent Jourdren</a>, Genomic Paris Centre</li>
<li>  <a href="https://github.com/akahles">Andr√© Kahles</a>, PhD<br>
</li>
<li>  <a href="https://github.com/nunofonseca">Nuno Fonseca</a>, PhD<br>
</li>
<li>  <a href="https://github.com/KjongLehmann">Kjong Lehmann</a>, PhD</li>
</ul>

<hr>

<h3>
<a id="-required-configurations-host-unix-system" class="anchor" href="#-required-configurations-host-unix-system" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a> Required configurations host unix system:</h3>

<h4>
<a id="-install-and-config-docker" class="anchor" href="#-install-and-config-docker" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a> Install and config docker</h4>

<p>To avoid running out of space on root drive, it is recommended to edit <code>/etc/sysconfig/docker</code> in CentOS or <code>/etc/default/docker</code> in Ubuntu, and set docker container PATH to large storage drive. It is also suggested to use local DNS instead of default Google DNS in docker config to avoid issues with downloading remote data. Sample docker configs are given within git repository (below) under <code>./info/docker_host_configs</code> directory.</p>

<pre><code>docker pull dyndna/pcawg14_htseq:0.9.2
docker images
</code></pre>

<p>If downloaded docker image has name other than <em>dyndna/pcawg14_htseq:0.9.2</em>, rename or create alias image as follows:</p>

<pre><code>docker tag &lt;IMAGE ID&gt; dyndna/pcawg14_htseq:0.9.2
</code></pre>

<h4>
<a id="set-myworkdir-variable" class="anchor" href="#set-myworkdir-variable" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Set <em>MYWORKDIR</em> variable</h4>

<p>This is a PATH within docker container and not necessarily should be present in host OS. You can keep in host <code>~/.bash_profile</code></p>

<pre><code>export MYWORKDIR="/scratch"
</code></pre>

<h4>
<a id="set-up-base-directory" class="anchor" href="#set-up-base-directory" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Set up base directory</h4>

<p>Go to host directory under which all data needs to be stored. Please read WARNING note below. Ideally, base directory should be freshly created directory under a non-system storage or scratch drive.</p>

<pre><code>cd /data/vol1
</code></pre>

<h5>
<a id="-warning-" class="anchor" href="#-warning-" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a> WARNING </h5>

<p>Current docker version 1.6.0 continues to have inherent security weakness by not separating root privileges between host system and docker container(s). This will results in allowing docker container to gain root privileges for host system. You may force ownership to some dummy user, <em>foo</em> by passing <code>-e USER=$USER -e USERID=$UID</code> variables in <code>docker run</code> argument at <code>./scripts/batchrun/docker_batchrun_all.txt</code>, and thus disallow docker container to gain root privileges. If you do so or in any other case, <strong>PLEASE DO NOT MOUNT</strong> root block device or <code>\</code> or $HOME <code>/~</code> as base directory, and instead use separate drive or block device other than disk where host system is mounted. However, keep in mind that binding non-root UID will <em>recursively and irreversibly change owner permission</em> of all files and directories under base directory in host system. It goes without saying that <strong>this can easily break your system, including lock you out of system if you mount system-level directories or entire user home directory as docker base directory.</strong></p>

<p>docker works best if used with care! More on security issues and how to minimize vulnerabilities: <a href="https://docs.docker.com/articles/security">https://docs.docker.com/articles/security</a></p>

<p>Dockerfile for image, <em>dyndna/pcawg14_htseq:0.9.2</em> can be seen at <a href="https://registry.hub.docker.com/u/dyndna/docker-for-pcawg14-htseq/dockerfile/">https://registry.hub.docker.com/u/dyndna/docker-for-pcawg14-htseq/dockerfile/</a> If you build <em>dyndna/pcawg14_htseq:0.9.2</em> from source, image may have different name. If so, rename it as follows:</p>

<pre><code>docker tag &lt;IMAGE ID&gt; dyndna/pcawg14_htseq:0.9.2
</code></pre>

<h4>
<a id="-set-up-work-dir" class="anchor" href="#-set-up-work-dir" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a> Set up work dir</h4>

<p>Your work dir will be mounted as <code>/scratch</code> in docker container. Configure work directory as follows without changing any dir/file names:</p>

<pre><code>pwd # your base directory, e.g., /data/vol1
git clone https://github.com/dyndna/pcawg14_htseq.git
cd pcawg14_htseq
ls
</code></pre>

<p>Directory structure under work dir: <code>&lt;basedir&gt;/pcawg14_htseq/</code></p>

<blockquote>
<p>info  LICENSE  README.md  sample_batchscript.sh  scripts  set_env</p>
</blockquote>

<h5>
<a id="required-edits-in-workdir" class="anchor" href="#required-edits-in-workdir" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Required edits in workdir</h5>

<ul>
<li><p>Move or symlink your cghub download credential file at <code>&lt;workdir&gt;/info/cgkey</code></p></li>
<li><p>Use default extended annotation GTF, <em>rnaseq.gc19_extNc.gtf</em> or move/symlink your GTF file at <code>&lt;workdir&gt;/info/htseq.gtf</code></p></li>
</ul>

<pre><code>cd &lt;workdir&gt;/info
tar xvzf htseq.gtf.tar.gz
mv rnaseq.gc19_extNc.gtf htseq.gtf
md5sum htseq.gtf
</code></pre>

<p>If you are using default extended annotation GTF derived from <a href="https://www.synapse.org/#!Synapse:syn3606092">https://www.synapse.org/#!Synapse:syn3606092</a>, MD5 checksum for <code>htseq.gtf</code> must match <em>48245eeff794b9e686466a80e66905c9</em></p>

<p>bed to gtf conversion for syn3606092 file, <em>rnaseq.gc19_extNc.bed</em> was done as follows:</p>

<p>Ref.: <a href="http://onetipperday.blogspot.com/2012/08/convert-bed-to-gtf.html">http://onetipperday.blogspot.com/2012/08/convert-bed-to-gtf.html</a></p>

<pre><code>#wget http://hgdownload.cse.ucsc.edu/admin/exe/linux.x86_64/bedToGenePred
#wget http://hgdownload.cse.ucsc.edu/admin/exe/linux.x86_64/genePredToGtf
&lt;workdir&gt;/scripts/bedToGenePred rnaseq.gc19_extNc.bed rnaseq.gc19_extNc.btgp.genepred
&lt;workdir&gt;/scripts/genePredToGtf file rnaseq.gc19_extNc.btgp.genepred rnaseq.gc19_extNc.gptg.gtf

cat rnaseq.gc19_extNc.gptg.gtf | awk 'BEGIN{FS="::|transcript_id"}{printf($1"::"$2"::"$3"\"; transcript_id"$5"::"$6"::"$7"::"$8"::"$9"::"$10"::"$11"\n")}' | sed -e "s/^chrM/MT/g;s/^chr//g"  &gt; rnaseq.gc19_extNc.gtf
</code></pre>

<ul>
<li>  Obtain updated CGHub bam file summary tsv file from <a href="https://browser.cghub.ucsc.edu">https://browser.cghub.ucsc.edu</a>
</li>
</ul>

<h4>
<a id="docker-command" class="anchor" href="#docker-command" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>docker command:</h4>

<h5>
<a id="-single-sample-run" class="anchor" href="#-single-sample-run" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a> Single sample run:</h5>

<p>Using bam file related attributes from downloaded cghub summary file, run docker command as follows:</p>

<blockquote>
<p>docker run -d -v <strong><em>basedir</em></strong>/pcawg14_htseq:$MYWORKDIR -e MYWORKDIR=$MYWORKDIR -w=$MYWORKDIR dyndna/pcawg14_htseq:0.9.2 /bin/bash -c "source ${MYWORKDIR}/set_env/bash_profile &amp;&amp; source ${MYWORKDIR}/scripts/htseq_docker_run.sh <strong><em>"analysis_id" "filename" "checksum"</em></strong> | tee -a ${MYWORKDIR}/logs/htseq_docker_brc.log"</p>
</blockquote>

<p>Example:</p>

<pre><code>docker run -d -v /data/vol1/pcawg14_htseq:$MYWORKDIR -e MYWORKDIR=$MYWORKDIR -w=$MYWORKDIR dyndna/pcawg14_htseq:0.9.2 /bin/bash -c "source ${MYWORKDIR}/set_env/bash_profile &amp;&amp; source ${MYWORKDIR}/scripts/htseq_docker_run.sh "b227b026-ef3b-4194-b833-d6386e906587" "PCAWG.057da4ba-421e-4f39-afa8-c7de2ca665e2.TopHat2.v1.bam" "38c067f8289e9c0689fed2c54e9b569e" | tee -a ${MYWORKDIR}/logs/htseq_docker_brc.log"
</code></pre>

<h5>
<a id="-batch-run" class="anchor" href="#-batch-run" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a> Batch run:</h5>

<p>First, make format for <code>docker run</code> command as per <code>./scripts/batchrun/docker_batchrun_all.txt</code> using R script, <code>./scripts/batchrun/pcawg14_htseq_docker_batchrun.Rmd</code></p>

<p>Then, go to workdir and execute following command to run sample 1 to 100.</p>

<pre><code>cd &lt;workdir&gt;
./scripts/batchrun/batchrun_docker.sh 1 100 ./scripts/batchrun/docker_batchrun_all.txt &gt; ./logs/batch_1_100.log 2&gt;&amp;1 &amp;
</code></pre>

<p>You can do pseudo parallelization by executing above script after fixed wait time, e.g., after 1 hour or so for allowing preceding sample to be downloaded and name sorted. Here is an example batch script to run three samples in parallel and process upto 300 samples. Please check <code>./sample_batchscript.sh</code> to confirm/edit your workdir. You may use GNU Screen or <code>nohup</code> command to keep script alive after exiting terminal session. </p>

<pre><code>./sample_batchscript.sh | tee -a logs/brc1_batchscripts_11_300.log
</code></pre>

<h4>
<a id="logging" class="anchor" href="#logging" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>logging:</h4>

<p>Although not clean, this pipeline will keep master log in <code>./logs/htseq_docker_brc.log</code> and individual batch run summary under <code>./logs/batch_*.log</code></p>

<p>To know how many samples have been processed successfully, run <code>ls ./processed/*.gto | wc -l</code>.</p>

<p>END</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/dyndna/pcawg14_htseq">PCAWG14-3 extended noncoding RNA Profiling</a> is maintained by <a href="https://github.com/dyndna">dyndna</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-307297-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
